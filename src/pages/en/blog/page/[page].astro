---
import { getCollection } from "astro:content";
import BaseHead from "../../../../components/base/BaseHead.astro";
import Footer from "../../../../components/base/Footer.astro";
import Navigation from "../../../../components/base/Navigation.astro";
import BlogPostList from "../../../../components/widgets/BlogPostList.astro";
import HeroSubpage from "../../../../components/widgets/HeroSubpage.astro";
import { imageProvider } from "../../../../provider/imageProvider";
import { getLangFromUrl, useTranslations, useTranslatedPath } from "../../../../i18n/utils";
import { SITE_TITLE, SITE_DESCRIPTION } from "../../../../consts";

export async function getStaticPaths() {
  const postsPerPage = 6;
  const allPosts = await getCollection("blogEn");
  const totalPages = Math.max(1, Math.ceil(allPosts.length / postsPerPage));
  return Array.from({ length: totalPages - 1 }, (_, i) => ({
    params: { page: String(i + 2) },
  }));
}

const POSTS_PER_PAGE = 6;

const { page } = Astro.params;
const pageNum = parseInt(page ?? "2", 10);

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);

const blogHeroUrl =
  typeof imageProvider.hero.headerBackground.src === "object"
    ? imageProvider.hero.headerBackground.src.src
    : imageProvider.hero.headerBackground.src;

const allPosts = (await getCollection("blogEn")).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);
const totalPages = Math.max(1, Math.ceil(allPosts.length / POSTS_PER_PAGE));
const currentPage = Math.min(Math.max(1, pageNum), totalPages);
const start = (currentPage - 1) * POSTS_PER_PAGE;
const posts = allPosts.slice(start, start + POSTS_PER_PAGE).map((p) => ({
  description: p.data.description,
  heroImage: p.data.heroImage,
  id: p.id,
  pubDate: p.data.pubDate,
  slug: p.id.replace(/^en\//, ""),
  title: p.data.title,
}));
---

<!doctype html>
<html lang={lang}>
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} lang={lang} />
  </head>
  <body>
    <div class="relative">
      <Navigation />
      <main>
        <HeroSubpage
          title={t("hero.blog.title")}
          imageUrl={blogHeroUrl}
        />
        <BlogPostList
          badge={t("blog.badge")}
          currentPage={currentPage}
          description={t("blog.description")}
          getPageHref={(p) => (p === 1 ? translatePath("/blog/") : translatePath(`/blog/page/${p}/`))}
          getPostHref={(slug) => translatePath(`/blog/${slug}/`)}
          locale={lang === "en" ? "en-GB" : "de-DE"}
          paginationNextText={t("blog.paginationNext")}
          paginationPrevText={t("blog.paginationPrev")}
          posts={posts}
          readMoreText={t("blog.readMore")}
          theme="grey"
          title={t("blog.title")}
          totalPages={totalPages}
        />
      </main>
      <Footer />
    </div>
  </body>
</html>
