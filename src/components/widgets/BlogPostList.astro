---
import Button from "../ui/Button.astro";

/**
 * Single blog post entry for the list.
 */
interface BlogPostItem {
  description: string;
  heroImage?: string;
  id: string;
  pubDate: Date;
  slug: string;
  title: string;
}

interface Props {
  /**
   * Optional badge text above the section title.
   */
  badge?: string;
  /**
   * Current page number (1-based).
   */
  currentPage: number;
  /**
   * Optional description paragraph under the section title.
   */
  description?: string;
  /**
   * Function to translate post URLs (e.g. translatePath(`/blog/${slug}/`)).
   */
  getPostHref: (slug: string) => string;
  /**
   * Function to get pagination URLs (e.g. page 1 = /blog/, page 2 = /blog/page/2/).
   */
  getPageHref: (page: number) => string;
  /**
   * Locale for date formatting (e.g. "de-DE" or "en-GB").
   */
  locale: string;
  /**
   * Label for "Next" button.
   */
  paginationNextText: string;
  /**
   * Label for "Previous" button.
   */
  paginationPrevText: string;
  /**
   * List of blog posts to display.
   */
  posts: BlogPostItem[];
  /**
   * Label for the "read more" button.
   */
  readMoreText: string;
  /**
   * Color theme: light (white), dark, or grey.
   */
  theme?: "light" | "dark" | "grey";
  /**
   * Optional section heading.
   */
  title?: string;
  /**
   * Total number of pages.
   */
  totalPages: number;
}

const { badge, currentPage, description, getPostHref, getPageHref, locale, paginationNextText, paginationPrevText, posts, readMoreText, theme = "light", title, totalPages } = Astro.props;

const showPagination = totalPages > 1;

/** Page numbers to show (all pages if ≤7, otherwise first + range + last) */
function getPageNumbers(): (number | "ellipsis")[] {
  if (totalPages <= 7) {
    return Array.from({ length: totalPages }, (_, i) => i + 1);
  }
  const pages: (number | "ellipsis")[] = [1];
  if (currentPage > 3) pages.push("ellipsis");
  const start = Math.max(2, currentPage - 1);
  const end = Math.min(totalPages - 1, currentPage + 1);
  for (let i = start; i <= end; i++) {
    if (!pages.includes(i)) pages.push(i);
  }
  if (currentPage < totalPages - 2) pages.push("ellipsis");
  if (totalPages > 1) pages.push(totalPages);
  return pages;
}

const isDark = theme === "dark";
const isGrey = theme === "grey";

const sectionBgClass = isDark
  ? "bg-dark-bg"
  : isGrey
    ? "bg-slate-100"
    : "bg-white";

const titleClass = isDark ? "text-white" : "text-dark";
const descClass = isDark ? "text-white/80" : "text-dark/70";
const dateClass = isDark ? "text-primary-light" : "text-primary";
const cardBgClass = isDark
  ? "bg-white/5"
  : isGrey
    ? "bg-white"
    : "bg-slate-100";

function formatDate(date: Date, locale: string): string {
  return new Intl.DateTimeFormat(locale, {
    day: "numeric",
    month: "long",
    year: "numeric",
  }).format(date);
}
---

{/* BlogPostList: Section with optional header + list of blog post cards */}
<section class:list={["relative overflow-hidden", sectionBgClass]}>
  <div class="mx-auto max-w-7xl px-6 py-12 md:px-12 md:py-20 lg:px-16 lg:py-24 min-[1920px]:max-w-8xl">
    {/* Section header: badge, title, description (all optional) */}
    {(badge || title || description) && (
      <div class="fade-in-section mb-8 max-w-4xl md:mb-12">
        {badge && (
          <div class="mb-4 inline-block rounded-tl-xl rounded-br-xl bg-gradient-to-r from-primary to-primary-light px-3 py-1 md:mb-6">
            <h3 class="font-outfit text-sm uppercase tracking-wider text-white leading-[1.3] md:text-base">
              {badge}
            </h3>
          </div>
        )}
        {title && (
          <h2
            class:list={[
              "font-anton text-3xl leading-tight md:text-4xl lg:text-5xl",
              titleClass,
            ]}
          >
            {title}
          </h2>
        )}
        {description && (
          <p
            class:list={[
              "mt-1 text-base font-light leading-relaxed md:text-lg",
              descClass,
            ]}
          >
            {description}
          </p>
        )}
      </div>
    )}

    {/* Blog post cards: 2-column grid, vertical cards (image top, content below) */}
    <ul class="grid grid-cols-1 gap-6 list-none m-0 p-0 sm:grid-cols-2 md:gap-8 lg:grid-cols-3">
      {
        posts.map((post) => (
          <li class="fade-in-section">
            <article
              class:list={[
                "blog-post-card group flex flex-col overflow-hidden rounded-br-4xl",
                cardBgClass,
              ]}
            >
              <a
                href={getPostHref(post.slug)}
                class="block aspect-video overflow-hidden"
              >
                <img
                  width={720}
                  height={400}
                  src={post.heroImage ?? "/blog-placeholder-3.jpg"}
                  alt=""
                  class="h-full w-full object-cover transition-transform duration-500 ease-out group-hover:scale-110"
                />
              </a>
              <div class="flex flex-1 flex-col p-6 md:p-8">
                <time
                  datetime={post.pubDate.toISOString()}
                  class:list={["font-outfit text-sm mb-1", dateClass]}
                >
                  {formatDate(post.pubDate, locale)}
                </time>
                <h3 class="m-0 font-anton text-xl leading-tight md:text-2xl">
                  <a
                    href={getPostHref(post.slug)}
                    class:list={[
                      "text-inherit no-underline transition-colors duration-200 hover:text-primary",
                      titleClass,
                    ]}
                  >
                    {post.title}
                  </a>
                </h3>
                <p
                  class:list={[
                    "font-outfit text-base mt-2 mb-4 line-clamp-3 leading-relaxed md:text-lg",
                    descClass,
                  ]}
                >
                  {post.description}
                </p>
                <Button href={getPostHref(post.slug)} class="mt-auto w-fit">
                  {readMoreText}
                </Button>
              </div>
            </article>
          </li>
        ))
      }
    </ul>

    {/* Pagination */}
    {showPagination && (
      <nav
        class="fade-in-section mt-12 flex flex-wrap items-center justify-center gap-2 md:mt-16"
        aria-label="Pagination"
      >
        {currentPage > 1 ? (
          <a
            href={getPageHref(currentPage - 1)}
            class="inline-flex min-h-10 items-center justify-center rounded-full border-2 border-primary bg-transparent px-4 py-2 font-outfit text-sm font-medium text-primary transition-colors hover:bg-primary hover:text-white"
          >
            {paginationPrevText}
          </a>
        ) : (
          <span
            class="inline-flex min-h-10 cursor-not-allowed items-center justify-center rounded-full border-2 border-dark/20 px-4 py-2 font-outfit text-sm text-dark/40"
            aria-disabled="true"
          >
            {paginationPrevText}
          </span>
        )}
        <div class="flex items-center gap-1">
          {getPageNumbers().map((page) =>
            page === "ellipsis" ? (
              <span class:list={["px-2 font-outfit text-dark/50", isDark && "text-white/50"]}>
                …
              </span>
            ) : page === currentPage ? (
              <span
                class:list={[
                  "flex h-10 min-w-10 items-center justify-center rounded-full font-outfit text-sm font-semibold",
                  isDark ? "bg-primary-light text-white" : "bg-primary text-white",
                ]}
                aria-current="page"
              >
                {page}
              </span>
            ) : (
              <a
                href={getPageHref(page)}
                class:list={[
                  "flex h-10 min-w-10 items-center justify-center rounded-full font-outfit text-sm font-medium transition-colors hover:bg-primary hover:text-white",
                  isDark ? "text-white/90 hover:text-white" : "text-dark hover:text-white",
                ]}
              >
                {page}
              </a>
            )
          )}
        </div>
        {currentPage < totalPages ? (
          <a
            href={getPageHref(currentPage + 1)}
            class="inline-flex min-h-10 items-center justify-center rounded-full border-2 border-primary bg-transparent px-4 py-2 font-outfit text-sm font-medium text-primary transition-colors hover:bg-primary hover:text-white"
          >
            {paginationNextText}
          </a>
        ) : (
          <span
            class="inline-flex min-h-10 cursor-not-allowed items-center justify-center rounded-full border-2 border-dark/20 px-4 py-2 font-outfit text-sm text-dark/40"
            aria-disabled="true"
          >
            {paginationNextText}
          </span>
        )}
      </nav>
    )}
  </div>
</section>

<style>
  .blog-post-card {
    transition: transform 0.3s ease-out;
  }
  .blog-post-card:hover {
    transform: translateY(-4px);
  }
</style>
